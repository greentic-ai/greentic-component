name: Auto tag crates on version change

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  autotag:
    runs-on: ubuntu-latest
    env:
      CARGO_HOME: ${{ runner.temp }}/cargo-home
    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@v2

      - name: Prepare cargo bin path
        run: |
          mkdir -p "${CARGO_HOME}/bin"
          echo "${CARGO_HOME}/bin" >> "$GITHUB_PATH"
          echo "${HOME}/.cargo/bin" >> "$GITHUB_PATH"

      - name: Install tomlq
        env:
          PATH: "${CARGO_HOME}/bin:${HOME}/.cargo/bin:${PATH}"
        run: cargo install --locked tomlq

      - name: Ensure scripts present
        run: |
          test -f scripts/version-tools.sh

      - name: Detect changed crate versions and create tags
        env:
          GIT_AUTHOR_NAME: ci-bot
          GIT_AUTHOR_EMAIL: ci-bot@users.noreply.github.com
          GIT_COMMITTER_NAME: ci-bot
          GIT_COMMITTER_EMAIL: ci-bot@users.noreply.github.com
        shell: bash
        run: |
          set -euo pipefail
          export PATH="${CARGO_HOME}/bin:${HOME}/.cargo/bin:$PATH"
          command -v tomlq >/dev/null 2>&1 || { echo "tomlq not found in PATH"; exit 127; }
          source scripts/version-tools.sh

          if ! PREV_HASH=$(git rev-parse HEAD^ 2>/dev/null); then
            echo "No previous commit detected; skipping tag creation."
            exit 0
          fi

          mapfile -t changed_manifests < <(git diff --name-only "$PREV_HASH" HEAD | grep -F "Cargo.toml" || true)
          if [ "${#changed_manifests[@]}" -eq 0 ]; then
            echo "No Cargo.toml changes detected in this push."
            exit 0
          fi

          tagged_any="false"

          for manifest in "${changed_manifests[@]}"; do
            if [ ! -f "$manifest" ]; then
              echo "Skipping removed manifest $manifest."
              continue
            fi
            name=$(tomlq -r .package.name < "$manifest")
            new_version=$(tomlq -r .package.version < "$manifest")
            if [ -z "$name" ] || [ -z "$new_version" ]; then
              echo "Skipping $manifest (missing name/version)."
              continue
            fi
            old_manifest=$(git show "$PREV_HASH:$manifest" 2>/dev/null || true)
            old_version=""
            if [ -n "$old_manifest" ]; then
              old_version=$(printf '%s' "$old_manifest" | tomlq -r .package.version 2>/dev/null || true)
            fi
            if [ "$old_version" = "$new_version" ]; then
              echo "Version unchanged for ${name} (${new_version}); skipping."
              continue
            fi
            tag="v${new_version}"
            if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
              echo "Annotated tag ${tag} already exists; skipping."
              continue
            fi
            echo "Creating annotated tag ${tag}"
            git tag -a "${tag}" -m "${name} ${new_version}"
            tagged_any="true"
          done

          if [ "$tagged_any" = "true" ]; then
            git push --tags
          else
            echo "No new crate versions detected in this push."
          fi
