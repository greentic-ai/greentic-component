# PR-04 — Doctor: enforce self-describing `describe()` (component@0.6.0)

Repo: `greentic-component`

## Goal
Upgrade `greentic-component doctor` from “exports exist + CBOR decodes” to **contract enforcement** for **fully self-describing 0.6.0 components**.

After this PR:
- `doctor` requires that `component-descriptor.describe()` returns a **typed, canonical CBOR** payload that includes:
  - MCP-like `operations[]` list
  - **inline SchemaIR** for each operation input/output
  - **inline SchemaIR** for component config
  - `schema_hash` per operation (computed over typed SchemaIR)
  - defaults/redactions/constraints (may be minimal but present and well-typed)
- `doctor` fails early (strict by default), with clear diagnostics and exit codes.

This PR does **not** change the wizard template output yet (that’s PR-06). It only updates doctor + tests/fixtures so we have a hard target.

## Scope
### In-scope
- Extend the doctor decoder to the new `greentic-types` v0.6.0 `ComponentDescribe` shape (operations + inline SchemaIR).
- Add strict validation rules and negative fixtures.
- Add stable hashing verification for `schema_hash` (hash over typed SchemaIR values, not raw bytes).
- Add i18n checks against `component-i18n.i18n-keys()` and QA specs (if available in doctor context).
- Add human + structured diagnostics.

### Out-of-scope
- Changing how components are generated (wizard) → PR-06.
- Emitting build artifacts (dist/*.describe.cbor) → PR-07.
- Any legacy/compat shims.

## Required contract (doctor expectations)
Doctor MUST treat the WASM as authoritative and enforce:

### A) Required exports exist and are callable
- `component-descriptor.get-component-info()`
- `component-descriptor.describe()`
- `component-qa.qa-spec(mode)` for all modes: default/setup/upgrade/remove
- `component-qa.apply-answers(mode, current-config, answers)`
- `component-i18n.i18n-keys()`
- `component-runtime.run(input, state)` (callability check only; deep validation is optional)

### B) `describe()` payload requirements
Doctor decodes `describe()` as `greentic-types::schemas::component::v0_6_0::ComponentDescribe` (expanded).

Doctor validates:
- `info.id`, `info.version`, `info.role` are non-empty
- `operations.len() > 0`
- Each operation has:
  - stable `id` (non-empty)
  - inline `input.schema` and `output.schema` (SchemaIR)
  - `schema_hash` present and correct
- `config_schema` present (SchemaIR)

### C) Strict schema rules (default)
Doctor fails if any of these are true:
- SchemaIR root is unconstrained “Any” (or equivalent)
- Object schemas have empty properties AND allow arbitrary additional properties without an explicit allowlist/policy
- String/number/array schemas have no constraints at all AND are not explicitly marked “permissive” (no permissive flag exists in this PR; strict only)

> Note: keep these rules *implementable* in v1. If SchemaIR has an explicit `Any`, reject it. If SchemaIR uses `Object { additional: Any }`, reject it unless policy metadata says it is intentionally permissive.

### D) Schema hash verification
- Compute `sha256` over canonical CBOR encoding of:
  - operation.input.schema
  - operation.output.schema
  - component.config_schema
- Compare with `operation.schema_hash`
- Fail on mismatch.

### E) QA + i18n consistency
For each mode in default/setup/upgrade/remove:
- `qa-spec(mode)` must decode as `greentic-types ComponentQaSpec`
- i18n keys referenced by QA spec must be a subset of `component-i18n.i18n-keys()`
- `apply-answers(mode, current-config, answers)` must return CBOR that decodes as config (Value/map) and optionally validates against `config_schema` if validator exists.

## Implementation tasks
1) **Update doctor decode path**
   - Replace/extend existing describe decoding to use the expanded `ComponentDescribe` type from `greentic-types`.

2) **SchemaIR validator**
   - Implement `validate_schema_ir(schema: &SchemaIr) -> Vec<Diagnostic>`
   - Implement “strict default” rules above.
   - Ensure deterministic diagnostics ordering (sort by path).

3) **Hash verifier**
   - Implement `compute_schema_hash(input: &SchemaIr, output: &SchemaIr, config: &SchemaIr) -> String`
   - Verify against `schema_hash`.

4) **QA/i18n checks**
   - Call `component-i18n.i18n-keys()` and store as a set.
   - For each mode, decode QA spec and validate key coverage.
   - Emit diagnostics for missing keys.

5) **Diagnostics**
   - Add a structured diagnostics output (JSON/CBOR) alongside human messages.
   - Return non-zero exit on any error.

6) **Tests + fixtures**
   Add fixtures under `tests/fixtures/`:
   - `good_component_describe.cbor` (generated from a fixed in-test struct encode or a tiny embedded fixture)
   - `bad_component_describe_missing_ops.cbor`
   - `bad_component_describe_unconstrained_schema.cbor`
   - `bad_component_describe_hash_mismatch.cbor`
   - `qa_spec_*` fixtures if needed

   Tests:
   - decode/encode roundtrip for describe (byte-identical if fixtures are bytes)
   - doctor passes on good fixture
   - doctor fails with correct diagnostics on each bad fixture

## CLI behavior changes
- `greentic-component doctor <path|wasm>` remains the entrypoint.
- Add `--format human|json` (default human) if not already present.
- Add `--strict` flag if you currently have permissive behavior; default should be strict for 0.6.0.

## Acceptance criteria
- `cargo test` passes.
- Doctor fails on unconstrained schemas by default.
- Doctor verifies schema_hash correctly.
- Doctor verifies QA i18n key coverage.
- Diagnostics are stable and deterministic.

## Notes
- This PR intentionally “pins” the contract before the wizard template is updated (PR-06). It’s OK if existing generated components fail doctor until PR-06 lands.

## Clarifications
- `doctor` is **strictly 0.6.0** in this PR line: enforce the 0.6.0 world + 0.6.0 `ComponentDescribe` only. No legacy (0.5.x) fallback/auto-detect. If a legacy component is passed, fail with a clear “not a 0.6.0 component” diagnostic.
- `component-i18n.i18n-keys()` is **required**. Missing export is a hard failure (strict by default).
- No permissive escape hatch in PR-04/06/07. If an escape hatch is ever added later, it must be explicit and loud (e.g. `--allow-unconstrained-schema`). For now: strict only.
