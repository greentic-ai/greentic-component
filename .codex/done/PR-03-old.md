PR 3 — greentic-component: Emit add-step-ready StepSpec (name-based node_id + schema-valid defaults)

Repo: greentic-component
Branch: feat/step-emission-v1
Goal: Components generated by greentic-component new + build must produce dev_flows that emit StepSpec JSON which greentic-flow add-step can insert without guessing, and which is always schema-valid for component.exec.

Non-negotiables

Do not emit tool anywhere.

Do not emit placeholder node_id like COMPONENT_STEP.

Default config flow emission must produce schema-valid input for the selected operation (or the default flow must not be generated).

Use manifest.name (e.g. hello-world) as the node_id hint.

Deliverables
A) Update dev_flow emission template

Current template in component.manifest.json uses:

node_id: "COMPONENT_STEP"

component.exec with input: {}

Change dev_flow templates to:

node_id: the component name, not id, not placeholder.

Use manifest.name (e.g. hello-world).

component.exec:

component: full id (e.g. ai.greentic.hello-world)

operation: default_operation (must exist)

input: populated with defaults (see below)

routing remains:

{ "to": "NEXT_NODE_PLACEHOLDER" }

Example emitted JSON (string template):

{
  "node_id": "hello-world",
  "node": {
    "component.exec": {
      "component": "ai.greentic.hello-world",
      "operation": "handle_message",
      "input": { "input": "Hello from hello-world!" }
    },
    "routing": [{ "to": "NEXT_NODE_PLACEHOLDER" }]
  }
}

B) Ensure scaffolded IO schemas include defaults for required fields (v1 usability)

Your scaffold currently makes input required but no default. That makes default mode produce invalid {}.

Update scaffolding of:

schemas/io/input.schema.json

schemas/io/output.schema.json (optional)

For hello-world:

add "default": "Hello from hello-world!" to the required input property.

C) Make build compute default input map deterministically

In greentic-component build, when generating/refreshing dev_flows:

Load the operation’s input schema (from the manifest’s schemas.input path).

Compute a default payload:

for each required property:

if it has default, use it

else fail default flow generation with clear error:

“Required field <field> has no default; cannot generate default dev_flow. Provide defaults or use custom mode.”

Write the computed default input into the emitted template for default dev_flow.

Strict rule: default dev_flow must either be schema-valid or not exist.

D) Ensure manifest operations are objects (if not already finalised)

You hit a parsing mismatch earlier. Make sure this repo emits operations in the shape required by the current greentic-dev / greentic-types:

operations: [ { name, input_schema?, output_schema?, ... } ]

default_operation must match one of the names.

(If you already fixed this, keep tests to prevent regression.)

Tests (must be real)

Scaffold output test

greentic-component new --non-interactive ...

Assert:

default_operation exists

operations non-empty

schemas/io/input.schema.json required fields have defaults (for the template)

Build produces add-step-ready emission

Run greentic-component build

Read the emitted dev_flow template string for default and assert:

node_id equals manifest.name

contains "component.exec"

contains "operation": "<default_operation>"

input contains all required fields from schema (not {})

contains NEXT_NODE_PLACEHOLDER

does not contain "tool" or "COMPONENT_STEP"

Default dev_flow omitted or fails when defaults missing

Modify input schema to remove defaults for a required field

Build should:

either omit default dev_flow OR fail with explicit error (choose one; recommended: omit default, keep custom)

Definition of done

New component + build yields a dev_flow default emission that add-step can insert without manual edits.

No legacy / tool concepts remain.