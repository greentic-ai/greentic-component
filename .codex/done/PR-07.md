# PR-07 — Build artifacts + Inspect + CI E2E for self-describing components (0.6.0)

Repo: `greentic-component`

## Goal
Complete the “authoring loop” for 0.6.0 self-describing components:
- build emits deterministic **contract artifacts**
- `inspect` shows exactly what downstream tools will see (MCP-style list-tools equivalent)
- CI runs wizard → build → doctor → inspect on a real generated component

This PR makes schema drift practically impossible during authoring and review.

## Scope
### In-scope
1) Build outputs:
   - `dist/<name>__0_6_0.wasm`
   - `dist/<name>__0_6_0.describe.cbor`
   - optional `dist/<name>__0_6_0.describe.json` (debug render)
2) `greentic-component inspect <wasm>`:
   - calls `describe()` and renders:
     - tool/operation list
     - input/output/config SchemaIR (inline)
     - defaults/redactions/constraints
   - schema_hash verification results (optional flag)
   - default behavior: call WASM export; optional `--describe <file.cbor>` renders from artifact without executing wasm
3) CI smoke test:
   - `wizard new demo`
   - `make wasm` or `greentic-component build`
   - `greentic-component doctor` must pass (strict)
   - `greentic-component inspect` must succeed and produce stable output
4) Add negative CI tests (lightweight):
   - a fixture component/project with unconstrained schema fails doctor

### Out-of-scope
- Updating greentic-flow/greentic-pack (separate repo PRs)
- Any legacy adapters

## Implementation tasks
### 1) Build command / Makefile integration
- Ensure the generated Makefile (PR-02) includes a target that:
  - builds wasm
  - runs `greentic-component build` (or equivalent) to write `describe.cbor`
- In greentic-component CLI, extend or introduce `greentic-component build` to produce artifacts. Keep `inspect` read-only (no emit).

### 2) Describe artifact writer
- Implement:
  - load wasm
  - call `describe()`
  - write canonical CBOR to `dist/*.describe.cbor`
  - optionally render JSON debug from typed `ComponentDescribe` for human inspection

### 3) Inspect UX
- `inspect` should:
  - summarize component info
  - list operations
  - for each operation, print schema_hash and brief schema stats (type/object fields count)
  - optionally `--json` output for machines

### 4) Contract verification option
- Add `inspect --verify`:
  - recompute schema_hash over typed SchemaIR and compare
  - report mismatches as non-zero exit
  - works whether data came from wasm (`inspect <wasm>`) or `--describe <file.cbor>`

### 5) CI
Add CI workflow steps:
- `cargo test`
- `greentic-component wizard new demo --abi-version 0.6.0 --out /tmp/demo`
- build demo (using Makefile target or cargo component build)
- run doctor on built wasm or project
- run inspect and verify
- store `describe.cbor` as artifact (always; cheap + high value)

### 6) Example component
- Either commit a small example under `examples/` OR rely on generated demo in CI (recommended: both)
- Ensure example passes doctor strict checks

## Acceptance criteria
- Build emits `dist/*.describe.cbor` deterministically.
- `inspect` accurately reflects WASM `describe()` payload.
- CI E2E smoke passes and prevents regressions.
- `inspect --verify` detects tampered schema_hash.

## Notes
- This PR makes it easy for greentic-flow and greentic-pack to rely solely on WASM describe, because authors can review the exact describe payload at build time.
