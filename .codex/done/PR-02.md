---
id: PR-02
title: Versioned WASM builds + Makefile + abi-version metadata
date: 2026-02-05
repo: greentic-component
track: component-wizard
depends_on: [PR-01]
---

# PR-02: Versioned WASM builds + Makefile + abi-version metadata

## Goal
Enhance the generated template to support a standardized build workflow and versioned WASM artifact naming:

- Build output: `<name>__<abi_version_with_underscores>.wasm`
  - e.g. `my_component__0_6_0.wasm`, `my_component__0_7_1.wasm`, `my_component__1_2_4.wasm`

## Changes
### 1) Template Makefile
`wizard new` must generate a `Makefile` with targets:

- `make build`  (native build)
- `make test`
- `make fmt`
- `make clippy`
- `make wasm`   (build component wasm; location/target per repo convention)
- `make doctor` (runs `greentic-component doctor` on this component)

The Makefile must:
- compute ABI version string from a single source of truth (see below)
- name the wasm output with the `<name>__<abi>.wasm` convention
- avoid platform-specific assumptions (Linux/macOS)
Recommended Makefile behavior (portable):
- Use `cargo component build --release` if that is the repo standard, then copy/rename the resulting `.wasm` into `./dist/`.
- Output path convention: `dist/<name>__<abi_with_underscores>.wasm`.

### 2) ABI version single source of truth
Add one of:
- Cargo.toml `[package.metadata.greentic] abi_version = "0.6.0"`
or
- a small Rust `pub const ABI_VERSION: &str = "0.6.0";`

Prefer Cargo metadata so tooling can read without compiling.

### 3) Wizard new updates
- Persist the ABI version in the generated crate metadata.
- Ensure future values (0.7.1, 1.2.4) only affect output naming and metadata, not template semantics (still 0.6.0 template until expanded).

### 4) Basic smoke validation
Add a lightweight test in greentic-component (not inside generated crate) that:
- generates a temp template
- asserts Makefile contains the wasm naming pattern
Optionally, if CI can compile wasm quickly, also build and check output file name.

## Acceptance criteria
- Generated template includes Makefile with required targets.
- Wasm build produces `<name>__0_6_0.wasm` by default.
- ABI version stored in one canonical location.

## Clarifications
- Use Cargo metadata as the single source of truth:
  - `[package.metadata.greentic]`
  - `abi_version = "0.6.0"`
- Preserve the `<name>` passed to `wizard new` for wasm naming; validate it against Cargo package name rules rather than silently lowercasing.
