---
source: crates/greentic-component/tests/new_scaffold.rs
assertion_line: 71
expression: lib_rs.trim()
---
use greentic_interfaces_guest::component::node::InvokeResult;
use greentic_interfaces_guest::component_entrypoint;

#[cfg(target_arch = "wasm32")]
#[used]
#[unsafe(link_section = ".greentic.wasi")]
static WASI_TARGET_MARKER: [u8; 13] = *b"wasm32-wasip2";

component_entrypoint!({
    manifest: crate::describe_payload,
    invoke: crate::handle_message,
    invoke_stream: true,
});

pub fn describe_payload() -> String {
    serde_json::json!({
        "component": {
            "name": "demo-component",
            "org": "ai.greentic",
            "version": "0.1.0",
            "world": "greentic:component/component@0.6.0",
            "schemas": {
                "component": "schemas/component.schema.json",
                "input": "schemas/io/input.schema.json",
                "output": "schemas/io/output.schema.json"
            }
        }
    })
    .to_string()
}

pub fn handle_message(operation: String, input: String) -> InvokeResult {
    InvokeResult::Ok(format!("demo-component::{operation} => {}", input.trim()))
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn describe_payload_is_json() {
        let payload = describe_payload();
        let json: serde_json::Value = serde_json::from_str(&payload).expect("valid json");
        assert_eq!(json["component"]["name"], "demo-component");
    }

    #[test]
    fn handle_message_round_trips() {
        let value = handle_message("handle".to_string(), "demo".to_string());
        match value {
            InvokeResult::Ok(body) => assert!(body.contains("demo")),
            other => panic!("unexpected invoke result: {:?}", other),
        }
    }
}
